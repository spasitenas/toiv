### Практическая работа No6 – Основы работы с протоколом MQTT.
Пример топиков в MQTT:
```
# Датчик температуры на кухне home/kitchen/temperature
# Датчик температуры в спальне home/sleeping-room/temperature
# Датчик освещенности на улице
home/outdoor/light
```

Пример топика, в который датчик температуры, расположенный в спальной комнате, публикует данные брокеру:
```
/home/living-space/living-room1/temperature
```

Подписчик может так же получать данные сразу с нескольких топиков, для этого существуют wildcard. Они бывают двух типов: одноуровневые и многоуровневые. Для более простого понимания рассмотрим в примерах каждый из них:

1. Одноуровневый wildcard. Для его использования применяется символ «+»

К примеру, нам необходимо получить данные о температуры во всех спальных комнатах:
```
/home/living-space/+/temperature
```

В результате получаем данные с топиков:
```
/home/living-space/living-room1/temperature
/home/living-space/living-room2/temperature
/home/living-space/living-room3/temperature
```

2. Многоуровневый wildcard. Для его использования применяется символ «#» К примеру, чтобы получить данные с различных датчиков всех спален в доме:

```
/home/living-space/#
```

В результате получаем данные с топиков:
```
/home/living-space/living-room1/temperature
/home/living-space/living-room1/light1
/home/living-space/living-room1/light2
/home/living-space/living-room1/humidity
/home/living-space/living-room2/temperature
/home/living-space/living-room2/light1
```

### Часть 2. Подписка на топик
При помощи улиты mosquitto_sub подпишитесь на сообщения нескольких датчиков стенда, согласно варианту:

датчик температуры v3
```bash
mosquitto_sub -t "/devices/wb-msw-v3_21/controls/Temperature" -v  -p 1883
```

```bash
ssh user@192.168.2.24
```

1. Датчик движения устройства WB-MSW v.3 (5)
```bash
mosquitto_sub -t "/devices/wb-msw-v3_21/controls/Max Motion" -t "/devices/wb-msw-v3_21/controls/Current Motion" -v -p 1883
```

2. Датчик температуры устройства WB-MS v.2 (12)

```bash
mosquitto_sub -t "/devices/wb-ms_11/controls/Temperature" -v  -p 1883
```

Пример получения сообщений в результате успешной подписки:
```
~# mosquitto_sub -t '/devices/<Имя устройства>/controls/<Идентификатор датчика>' -v //команда на получение сообщения из топика

/devices//<Имя устройства>/controls/<Идентификатор датчика> 22.75 //в этой строке и ниже — вывод утилиты, полученные сообщения

/devices//<Имя устройства>/controls/<Идентификатор датчика> 22.75

/devices//<Имя устройства>/controls/<Идентификатор датчика> 22.75
```

### Часть 3. Управление устройствами
Для управления устройством (изменения значения канала), необходимо отправить сообщение в топик /devices/<device-id>/controls/<control-id>/on (обратите
внимание на /on в конце). Название топика можно также посмотреть в веб-интерфейсе контроллера во вкладке Settings – MQTT Channels. Это делается с помощью консольной команды mosquitto_pub.

Например, данная команда отправляет сообщение «1» (логическую единицу, «включить») в топик, соответствующий подключённому по RS-485 релейном модуле WM-MRM2 с адресом 130.

```
~# mosquitto_pub -t "/devices/wb-mrm2_130/controls/Relay 1/on" -m "1"
```

Включите или измените поведение устройств посредством отправки сообщение в соответствующий топик согласно вариантам:

1. Включите индикатор устройства WB-MSW v.3 (5)
2. Включите подсветку кнопки 28



-------


Ошибка "Permission denied" указывает на то, что у вас нет достаточных прав для подключения к MQTT-брокеру или для подписки на указанные топики. Вот несколько шагов, которые вы можете предпринять для решения этой проблемы:

1. Проверьте, запущен ли MQTT-брокер:
   ```
   sudo systemctl status mosquitto
   ```

2. Если брокер не запущен, попробуйте запустить его:
   ```
   sudo systemctl start mosquitto
   ```

3. Проверьте настройки аутентификации MQTT-брокера. Возможно, требуется указать имя пользователя и пароль. В этом случае добавьте параметры `-u` и `-P` к вашей команде:
   ```
   mosquitto_sub -u <username> -P <password> -t "/devices/wb-msw-v3/controls/+/on" -t "/devices/wb-ms-v2/controls/temperature" -v
   ```

4. Проверьте права доступа к MQTT-брокеру. Возможно, ваш пользователь не входит в нужную группу. Попробуйте выполнить команду от имени суперпользователя:
   ```
   sudo mosquitto_sub -t "/devices/wb-msw-v3/controls/+/on" -t "/devices/wb-ms-v2/controls/temperature" -v
   ```

5. Проверьте конфигурацию ACL (Access Control List) MQTT-брокера. Убедитесь, что у вашего пользователя есть права на подписку на эти топики.

6. Проверьте, правильно ли указаны топики. Возможно, в вашей системе используются другие названия для устройств или контролов.

7. Если вы используете локальный брокер на Wiren Board, попробуйте явно указать адрес localhost:
   ```
   mosquitto_sub -h localhost -t "/devices/wb-msw-v3/controls/+/on" -t "/devices/wb-ms-v2/controls/temperature" -v
   ```

Если проблема сохраняется, проверьте логи MQTT-брокера для получения дополнительной информации:

```
sudo tail -f /var/log/mosquitto/mosquitto.log
```

Это может дать вам более подробную информацию о причине отказа в доступе.

Ошибка "kex_exchange_identification: banner line contains invalid characters" обычно возникает при попытке установить SSH-соединение. Эта проблема может быть вызвана несколькими причинами:

1. Проблемы с сетевым соединением:
   - Нестабильное или медленное интернет-соединение
   - Проблемы с маршрутизацией

2. Проблемы на стороне сервера:
   - Неправильная конфигурация SSH-сервера
   - Сервер отправляет некорректный баннер приветствия

3. Проблемы с клиентским ПО:
   - Устаревшая версия SSH-клиента
   - Конфликт с антивирусом или файрволом

Для решения этой проблемы можно попробовать следующие шаги:

1. Проверьте сетевое соединение:
   ```
   ping <адрес_сервера>
   ```

2. Попробуйте подключиться с verbose-режимом для получения дополнительной информации:
   ```
   ssh -vv user@hostname
   ```

3. Убедитесь, что вы используете правильный порт (по умолчанию 22):
   ```
   ssh -p 22 user@hostname
   ```

4. Попробуйте подключиться с другого устройства или сети.

5. Если у вас есть доступ к серверу, проверьте конфигурацию SSH-сервера (/etc/ssh/sshd_config) и логи (/var/log/auth.log или /var/log/secure).

6. Обновите SSH-клиент до последней версии.

7. Временно отключите антивирус или файрвол для проверки.

8. Если проблема на стороне сервера, может потребоваться связаться с администратором сервера для проверки конфигурации SSH.

Если проблема сохраняется, предоставьте больше информации о вашей системе, версии SSH-клиента и сервера, к которому вы пытаетесь подключиться, для более точной диагностики.

Ошибка "kex_exchange_identification: connection closed by remote host" возникает при попытке установить SSH-соединение и указывает на то, что удаленный хост (сервер) закрыл соединение во время процесса обмена ключами (key exchange). Это может быть вызвано несколькими причинами:

1. Проблемы с сетевым подключением:
   - Нестабильное интернет-соединение
   - Проблемы с файерволом или NAT

2. Проблемы на стороне сервера:
   - Сервер перегружен или не отвечает
   - Неправильная конфигурация SSH-сервера
   - Сервер отклоняет соединения из-за настроек безопасности

3. Проблемы с аутентификацией:
   - Неправильные учетные данные
   - Истекший или отозванный ключ

4. Несовместимость версий SSH-клиента и сервера

Для решения этой проблемы попробуйте следующие шаги:

1. Проверьте сетевое подключение:
   ```
   ping <адрес_сервера>
   ```

2. Попробуйте подключиться с verbose-режимом для получения дополнительной информации:
   ```
   ssh -vv user@hostname
   ```

3. Убедитесь, что вы используете правильный порт (по умолчанию 22):
   ```
   ssh -p 22 user@hostname
   ```

4. Проверьте, не блокирует ли файервол SSH-трафик.

5. Попробуйте подключиться с другого устройства или сети.

6. Если у вас есть доступ к серверу, проверьте логи SSH (/var/log/auth.log или /var/log/secure) и состояние SSH-сервиса:
   ```
   sudo systemctl status sshd
   ```

7. Убедитесь, что ваши учетные данные или SSH-ключи актуальны и правильны.

8. Попробуйте использовать другую версию SSH-клиента или обновите текущую.

9. Если проблема на стороне сервера, может потребоваться связаться с администратором сервера для проверки конфигурации SSH и состояния сервера.

10. В некоторых случаях может помочь очистка известных хостов:
    ```
    ssh-keygen -R <hostname_or_ip>
    ```

Если проблема сохраняется после этих шагов, предоставьте более подробную информацию о вашей системе, версии SSH-клиента и сервера, к которому вы пытаетесь подключиться, для дальнейшей диагностики.
